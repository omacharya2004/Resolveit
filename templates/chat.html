<!doctype html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PingMe - {{ room }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
  </head>
  <body data-room="{{ room }}" data-username="{{ username }}">
    <nav class="navbar navbar-expand bg-body-tertiary px-3 shadow-sm">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center gap-2" href="/">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="PingMe" style="height:28px;width:28px;border-radius:6px;object-fit:cover">
          <span>PingMe</span>
        </a>
        <div class="d-flex align-items-center gap-2 ms-auto">
          <div class="input-group input-group-sm" style="max-width:240px">
            <span class="input-group-text">Code</span>
            <input id="room-code" class="form-control" value="{{ room }}" placeholder="0000">
            <button class="btn btn-outline-primary" id="share-room" type="button">Share</button>
          </div>
          <button class="btn btn-outline-secondary btn-sm" id="theme-toggle" type="button">Theme</button>
          <div class="dropdown">
            <button class="btn btn-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Profile</button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li class="dropdown-item-text"><strong>{{ username }}</strong> <span class="badge bg-success">online</span></li>
              <li><hr class="dropdown-divider"></li>
              <li class="dropdown-item-text small">Username: {{ username }}</li>
              <li class="dropdown-item-text small">Email: <span id="me-email">—</span></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/logout">Logout</a></li>
            </ul>
          </div>
          <a class="btn btn-outline-secondary btn-sm" href="/about">About</a>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-3">
      <ul class="nav nav-tabs mb-3" id="section-tabs">
        <li class="nav-item"><button class="nav-link active" data-section="room" type="button">Room</button></li>
      </ul>
      <div class="row g-3">
        <aside class="col-12 col-md-3 col-lg-2">
          <div class="card h-100 sidebar-card">
            <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
              <span>Code</span>
            </div>
            <div class="p-3">
              <div class="input-group input-group-sm">
                <span class="input-group-text">Room</span>
                <input id="room-code-side" class="form-control" value="{{ room }}" placeholder="0000">
                <button class="btn btn-outline-primary" id="share-room-side" type="button">Share</button>
              </div>
              <div class="form-text mt-2">Use this 4-digit code to join or share.</div>
            </div>
            <div class="card-header fw-semibold">Chats</div>
            <ul id="chat-list" class="list-group list-group-flush small online-list" style="max-height:40vh;overflow:auto"></ul>
          </div>
        </aside>
        <main class="col-12 col-md-9 col-lg-10">
          <div class="card h-100 chat-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold" id="context-title">Room: <span id="ctx-name">{{ room }}</span></div>
                <div class="small text-muted" id="context-sub"></div>
              </div>
              <div class="small d-flex gap-2 align-items-center">
                <button class="btn btn-sm btn-outline-secondary" id="switch-to-room">Room</button>
              </div>
            </div>
            <div id="messages" class="card-body chat-bg message-list" style="height:70vh; overflow:auto"></div>
            <div class="px-3 py-1 small text-muted" id="typing-indicator" style="min-height:20px;display:none">Someone is typing…</div>
            <div class="card-footer">
              <form id="message-form" class="d-flex gap-2 align-items-center">
                <input id="message-input" class="form-control" placeholder="Type a message" autocomplete="off">
                <button class="btn btn-primary px-4" type="submit">Send</button>
              </form>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/chat.js"></script>
    <script>
      (function(){
        // Share handlers (top & side)
        function buildInvite(code){ const url=new URL(window.location.href); url.search=''; url.hash=''; url.pathname='/'; url.searchParams.set('room', code); return url.toString(); }
        async function share(code, btn){ try{ await navigator.clipboard.writeText(buildInvite(code)); if(btn){ const txt=btn.textContent; btn.textContent='Copied!'; setTimeout(()=>btn.textContent=txt, 1200);} }catch(e){} }
        const shareTop = document.getElementById('share-room'); const inputTop = document.getElementById('room-code');
        if (shareTop){ shareTop.addEventListener('click', function(){ share(inputTop.value, shareTop); }); }
        const shareSide = document.getElementById('share-room-side'); const inputSide = document.getElementById('room-code-side');
        if (shareSide){ shareSide.addEventListener('click', function(){ share(inputSide.value, shareSide); }); }

        // Theme toggle
        const toggle = document.getElementById('theme-toggle');
        const html = document.documentElement; const key='pm-theme';
        function setTheme(t){ html.setAttribute('data-bs-theme', t); localStorage.setItem(key, t); }
        setTheme(localStorage.getItem(key) || 'dark');
        if (toggle){ toggle.addEventListener('click', function(){ const next = (html.getAttribute('data-bs-theme')==='dark'?'light':'dark'); setTheme(next); }); }

        // Tabs (only Room remains)
        const tabs = document.querySelectorAll('#section-tabs .nav-link');
        function setSection(sec){ tabs.forEach(b=>b.classList.toggle('active', b.dataset.section===sec)); }
        tabs.forEach(b=> b.addEventListener('click', ()=> setSection(b.dataset.section)));
        setSection('room');
      })();
    </script>
  </body>
  </html>


